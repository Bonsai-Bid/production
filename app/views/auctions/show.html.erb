<div class="container mx-auto mt-3 px-4">
  <% if notice %>
    <p class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert"><%= notice %></p>
  <% end %>
  <%= render @auction %>

  <% if current_user&.id == @auction.seller_id %>
    <div class="flex space-x-2 mt-4">
      <%= link_to "Edit this auction", edit_item_path(@auction.item), class: "btn bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700" %>
      <%= link_to "Delete Auction", item_path(@auction.item), method: :delete, class: "btn bg-red-500 text-white px-4 py-2 rounded hover:bg-red-700" %>
      <%= link_to "Back to Dashboard", dashboard_user_path(current_user), class: "btn bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-700" %>
    </div>
  <% end %>

  <% if current_user && current_user&.id != @auction.seller_id %>
    <div class="mb-3">
      <%= link_to 'Watch this Auction', watchlists_path(auction_id: @auction.id), method: :post, class: "btn bg-teal-500 text-white px-4 py-2 rounded hover:bg-teal-700" %>
    </div>
  <% end %>

  <%# Bidding functionality starts here %>
  <div class="mt-6">
    <h2 class="text-xl font-bold">Highest Bid</h2>
    <% if @auction.bids.any? %>
      <% highest_bid = @auction.bids.order(bid_amount: :desc).first %>
      <p><%= highest_bid.bidder.email %>: <%= number_to_currency(highest_bid.bid_amount) %></p>
      <%= link_to 'View Bidding History', bidding_history_auction_path(@auction), class: "btn bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700" %>
    <% else %>
      <% if @auction.active? %>
        <p>No bids have been placed yet.</p>
      <% else %>
        <% case @auction.status %>
        <% when "listed" %>
          <p>Bidding is not open. The auction is scheduled to start on <%= @auction.start_date.strftime('%Y-%m-%d %H:%M:%S') %>.</p>
        <% when "sold", "ended" %>
          <p>Bidding is closed.</p>
        <% end %>
      <% end %>
    <% end %>

    <% if user_signed_in? && current_user.id != @auction.seller_id %>
      <% case @auction.status %>
      <% when "active" %>
        <%= form_with(model: [@auction, Bid.new], local: true, class: "mt-4") do |form| %>
          <% if @bid&.errors&.any? %>
            <div id="error_explanation" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
              <h2 class="font-bold mb-2"><%= pluralize(@bid.errors.count, "error") %> prohibited this bid from being saved:</h2>
              <ul class="list-disc pl-5">
                <% @bid.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <div class="mb-4">
            <%= form.label :bid_amount, class: "block text-sm font-medium text-gray-700" %>
            <%= form.number_field :bid_amount, step: 0.01, class: "form-input mt-1 block w-full p-2 border rounded" %>
          </div>

          <div class="actions">
            <%= form.submit "Place Bid", class: "btn bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700" %>
          </div>
        <% end %>
        <p>Bidding will close on <%= @auction.end_date.strftime('%Y-%m-%d %H:%M:%S') %>.</p>

      <% end %>
    <% else %>
      <p>You must be logged in to place a bid.</p>
    <% end %>
  </div>
</div>
